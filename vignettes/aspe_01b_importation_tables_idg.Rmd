---
title: "1b. Importation des tables de la base ASPE depuis l'IDG (OFB)"
author: "Benoit Richard, Pascal Irz"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1b. Importation des tables de la base ASPE depuis l'IDG (OFB)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Objectif

R√©cemment (*depuis octobre 2025*), la base ASPE est pr√©sente dans l'IDG de l'OFB (= **I**nfrastructure de **D**onn√©es **G**√©ographiques).  

Il est donc maintenant possible d'importer directement les tables de la base ASPE depuis l'IDG (*sans passer par la conversion d'un dump ASPE* ; cf. `[vignette importation tables hubeau](https://pascalirz.github.io/aspe/articles/aspe_01_importation_tables.html)`).

A noter que cet acc√®s via l'IDG :

- est restreint aux agents de l'OFB, ayant pr√©alablement √©t√© inscrits comme utilisateurs ;
- se fait √† partir du r√©seau interne de l'OFB (ou via le VPN √† l'externe) ;
- n√©cessite de disposer des param√®tres de connexion √† la base IDG (adresse, login, ...).

Les tables import√©es sont sous la forme de `dataframes`, et sont directement utilisables depuis l'IDE utilis√© (comme `RStudio`), et sont compatibles avec les autres fonctions du package `{aspe}`.  

## Installer et charger le package `{aspe}`

Charger le package `{aspe}`, t√©l√©chargeable depuis GitHub :

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("pascalirz/aspe")
```

Eventuellement cette commande vous retournera un message demandant de mettre √† jour des `packages`. Acceptez au moins les mises √† jour depuis le [CRAN](https://cran.r-project.org/).

... et des autres qui sont n√©cessaires pour ex√©cuter les scripts.

```{r setup, message = FALSE, warning = FALSE, eval = FALSE}
library(aspe)
library(dplyr)
library(usethis)
```

## Stocker les informations de connexion dans son R environnement

Pour des raisons de s√©curit√© (*et de bonnes pratiques*), il convient de ne pas exposer les informations sensibles de connexion √† tous. C'est pourquoi, il est n√©cessaire de stocker ces informations dans  l'environnement `R` (fichier `.Renviron`). La fonction de connexion √† la base aspe via l'IDG utilise ces informations (c√†d. nomm√©es ainsi).

Pour stocker les informations dans votre environnement `R`, vous pouvez proc√©der comme ceci :

```{r, eval = FALSE}
## 1¬∞ - ouvrir le fichier de configuration de l'environnement R avec la fonction du package usethis (installer le package si n√©cessaire).
usethis::edit_r_environ()

## 2¬∞ - dans la fen√™tre ouverte intitul√©e '.Renviron', 
# sauvegarder les lignes suivantes avec le bon param√©trage
BDD_IDG_HOST = "URL_DE_LA_BDD"
BDD_IDG_LOGIN = "IDENTIFIANT_POUR_CONNEXION_A_LA_BDD"
BDD_IDG_PWD = "MDP_POUR_CONNEXION_A_LA_BDD"
BDD_IDG_PORT = "LE_PORT_DE_LA_BDD"
BDD_IDG_ASPE_NAME = 'NOM_DE_LA_BDD'
```

Sauvegarder le fichier `.Renviron` et red√©marrer votre session `R` pour que les informations renseign√©es soient utilisables.

Au red√©marrage, v√©rifier les informations stock√©es en tapant ces lignes suivantes :

```{r, eval = FALSE}
## 3¬∞ - ces informations doivent √™tre visibles dans la console R :
Sys.getenv('BDD_IDG_HOST')
Sys.getenv('BDD_IDG_LOGIN')
Sys.getenv('BDD_IDG_PWD')
Sys.getenv('BDD_IDG_PORT')
Sys.getenv('BDD_IDG_ASPE_NAME')
```

## Importation de la base depuis l'IDG

Apr√®s ces r√©glages, vous √™tes pr√™ts √† utiliser les fonctions li√©es √† l'IDG ü§©.

En pratique, il faut d'abord (i) se connecter √† la base de l'IDG, puis (ii) lancer l'importation. 

Deux fonctions facilitent le processus :

```{r, eval = FALSE}
# connexion √† l'IDG
# ! veillez √† disposer des informations de connexion et un droit d'acc√®s
aspe_db <- start_connexion_aspe_idg()

# importation des tables de la base aspe
imp_importer_aspe_idg(aspe_db)
```

Chaque table est import√©e une par une. L'op√©ration est assez rapide selon l'√©tat de votre connexion (*de l'ordre de 3 √† 5 min* üöÄ). 

![](img/message_connexion_dll_tables_idg.png)

Quand l'importation est termin√©e, une centaine de tables au format `dataframe` apparaissent dans l'onglet "Environnement" de RStudio.

Pour √©viter d'avoir √† r√©p√©ter cet import, on peut en sauvegarder le r√©sultat au format `.RData` de fa√ßon √† acc√©der plus rapidement aux donn√©es par la suite. La fonction `export_tables_rdata()` peut √™tre utilis√©e pour cela. 

Elle nomme les fichiers (`tables_sauf_mei` et `mesure_individuelle`) en fonction des dates et heures syst√®mes (pour √©viter d'√©craser malencontreusement d'anciens fichiers) et les sauvegarde par d√©faut dans un sous-r√©pertoire `/processed_data` du r√©pertoire de travail. Si celui-ci n'est pas pr√©-existant, il est cr√©√©.

> NB: Il est possible de scinder les tables `mesure_individuelle` en plusieurs parties afin de faciliter le d√©p√¥t sur des espaces de stockage (avec taille limit√©). Par exemple, pour cr√©er 2 parties, la fonction s'utilise comme ceci: `export_tables_rdata(n_fichiers_mei = 2)`.

```{r, eval = FALSE, message = FALSE, warning = FALSE}
export_tables_rdata()
```


